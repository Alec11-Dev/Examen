<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <title>Document</title>
</head>

<body class="bodyLogin">
    <div class="container">
        <div class="row justify-content-center align-items-center min-vh-100">
            <div class="col-12 col-md-8 col-lg-5">
                <form action="ValidationData/validate_sesion.php" method="POST"
                    class="formulario p-4 shadow rounded bg-white">
                    <h1>Iniciar sesión</h1>
                    <br>
                    <div class="mb-3">
                        <label for="exampleInputEmail1" class="form-label">Correo electrónico</label>
                        <input type="email" class="form-control" id="email" name="email" aria-describedby="emailHelp"
                            required autocomplete="on" placeholder="name@example.com">
                    </div>
                    <br>
                    <div class="mb-3">
                        <label for="exampleInputPassword1" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password">
                    </div>
                    <button type="submit" class="btn btn-primary">Ingresar</button>
                    <!-- <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> -->

                    <button class="btn facebook" type="button"
                        onclick="FB.login(checkLoginState, {scope: 'public_profile,email'});">
                        <svg viewBox="0 0 16 16" class="bi bi-facebook" fill="currentColor" height="16" width="16"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951z">
                            </path>
                        </svg>
                        Facebook
                    </button>

                    <br><br>
                    <div id="g_id_onload" data-client_id="918934300769-ee967b1l7cfc53462rrahs7j5bmu6a17.apps.googleusercontent.com"
                        data-callback="handleCredentialResponse">
                    </div>
                    <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline"
                        data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left">
                    </div>

                    <br><br>
                    <figcaption class="blockquote-footer">
                        Aún no tienes una cuenta? <cite title="Source Title"></cite>
                    </figcaption>
                    <a href="register.php">Haz clic aqui para registrarse</a>
                    <footer class="text-center mt-4 mb-3">
                        <p class="small text-muted">
                            &copy; 2024 BookLook.<br>
                            <a href="pages/condiciones.html" class="text-decoration-none">Términos y Condiciones</a> |
                            <a href="pages/politicas.html" class="text-decoration-none">Políticas de Privacidad</a> |
                            <a href="pages/eliminación_datos.html" class="text-decoration-none">Eliminación de Datos</a>
                        </p>
                    </footer>
                </form>
            </div>
        </div>
    </div>

    <script>
        window.fbAsyncInit = function () {
            FB.init({
                appId: '918938267254848',
                cookie: true,
                xfbml: true,
                version: 'v24.0'
            });
            FB.AppEvents.logPageView();
        };

        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {
                return;
            }
            js = d.createElement(s);
            js.id = id;
            js.src = "https://connect.facebook.net/es_LA/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        // Esta función se llama cuando el usuario hace clic en el botón de FB.
        function checkLoginState() {
            FB.getLoginStatus(function (response) {
                statusChangeCallback(response);
            });
        }

        // Esta función maneja el estado de la sesión.
        function statusChangeCallback(response) {
            if (response.status === 'connected') {
                // El usuario está logueado en Facebook y en tu app.
                // Obtenemos sus datos y los enviamos al servidor.
                console.log('Conectado y autorizado!');

                fetchFacebookUserInfo();
            } else {
                // El usuario no está logueado en Facebook, así que no sabemos si está en tu app.
                // O puede que haya cancelado el login.
                console.log('No conectado a Facebook o no autorizado.');
            }
        }

        // Función para obtener la información del usuario de Facebook
        function fetchFacebookUserInfo() {
            FB.api('/me', { fields: 'name,email,picture.width(200).height(200)' }, function (userInfo) {
                if (userInfo && !userInfo.error) {
                    enviarDatosAServidor(userInfo);
                } else {
                    console.error('Error al obtener datos de Facebook:', userInfo.error);
                    alert('No se pudieron obtener tus datos de Facebook. Por favor, intenta de nuevo.');
                }
            });
        }

        // Función para enviar los datos al backend de tu aplicación
        function enviarDatosAServidor(userInfo) {
            const datosUsuario = {
                nombre: userInfo.name,
                email: userInfo.email,
                facebook_id: userInfo.id,
                foto: userInfo.picture.data.url
            };

            // Apuntamos al script PHP correcto
            fetch('ValidationData/guardar_usuariofb.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datosUsuario)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // ¡Éxito! Redirigimos a la página principal correcta
                        window.location.href = "pages/menu.php";
                    } else {
                        // Mostramos un error más específico si el backend lo envía
                        let errorMsg = data.error ? data.error : "Error al procesar el inicio de sesión.";
                        alert(errorMsg);
                        console.error('Error del servidor:', errorMsg);
                    }
                })
                .catch(error => {
                    console.error('Error en la comunicación con el servidor:', error);
                    alert("Hubo un problema de conexión. Revisa la consola para más detalles.");
                });
        }
    </script>

    <!-- Librería de Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Lógica para manejar la respuesta de Google -->
    <script>
        function handleCredentialResponse(response) {
            // Enviamos el token (JWT) a nuestro backend PHP
            fetch('ValidationData/guardar_usuariogoogle.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: response.credential })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    window.location.href = "pages/menu.php";
                } else {
                    alert(data.error || "Error al iniciar sesión con Google");
                }
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>

</html>